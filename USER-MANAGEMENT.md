# User Management System

## Overview

The user management system integrates Firebase Authentication with MongoDB to provide a comprehensive user management solution for the InnerView therapy platform.

## User Roles

- **Admin** - Full system access, can manage all users and access all data
- **Manager** - Can manage users (except admins) and view all therapist data
- **Therapist** - Regular users who can only access their own clients and data

## Features

### Authentication
- Automatic user creation from Firebase authentication
- User status checking (active/inactive)
- Last login tracking
- Role-based access control

### User Management APIs

#### 1. Create/Sync User
```bash
POST /users
Body: {
  "fullName": "John Doe",
  "email": "john@example.com",
  "firebaseUid": "firebase-uid-here",
  "role": "therapist" // optional, defaults to therapist
}
```

#### 2. Sync from Firebase
```bash
POST /users/sync
Body: {
  "firebaseUid": "firebase-uid-here",
  "email": "john@example.com",
  "fullName": "John Doe" // optional
}
```

#### 3. Get Current User
```bash
GET /users/me
Authorization: Bearer <firebase-token>
```

#### 4. List All Users (Managers/Admins only)
```bash
GET /users?role=therapist&isActive=true&search=john
Authorization: Bearer <firebase-token>
```

#### 5. Get User by ID
```bash
GET /users/:userId
Authorization: Bearer <firebase-token>
```

#### 6. Update User
```bash
PATCH /users/:userId
Authorization: Bearer <firebase-token>
Body: {
  "fullName": "John Updated",
  "phoneNumber": "+1234567890"
}
```

#### 7. Update User Role (Managers/Admins only)
```bash
PATCH /users/:userId/role
Authorization: Bearer <firebase-token>
Body: {
  "role": "manager"
}
```

#### 8. Update User Status (Managers/Admins only)
```bash
PATCH /users/:userId/status
Authorization: Bearer <firebase-token>
Body: {
  "isActive": false
}
```

#### 9. Get User Statistics
```bash
GET /users/:userId/stats
Authorization: Bearer <firebase-token>
```

#### 10. Search by Email (Managers/Admins only)
```bash
GET /users/search?email=john@example.com
Authorization: Bearer <firebase-token>
```

#### 11. Bulk Update Status (Admins only)
```bash
POST /users/bulk/status
Authorization: Bearer <firebase-token>
Body: {
  "userIds": ["uid1", "uid2"],
  "isActive": false
}
```

## Initial Setup

### Creating the First Admin User

Run the admin creation script:

```bash
npm run create-admin <email> [name]
```

Example:
```bash
npm run create-admin admin@innerview.com "System Admin"
```

This will:
1. Create a Firebase user if it doesn't exist
2. Create or update the MongoDB user with admin role
3. Set a temporary password (TempPassword123!) that should be changed immediately

### Package.json Script

Add this to your package.json scripts:
```json
{
  "scripts": {
    "create-admin": "ts-node scripts/create-admin.ts"
  }
}
```

## Security Features

1. **Automatic User Creation**: When a Firebase user logs in for the first time, a user record is automatically created in MongoDB
2. **Role-Based Access**: Different endpoints and data access based on user roles
3. **User Status**: Inactive users are blocked from accessing the system
4. **Last Admin Protection**: System prevents deactivating or demoting the last admin user
5. **Self-Protection**: Users cannot deactivate their own accounts

## Database Schema

```typescript
{
  fullName: string;          // User's display name
  email: string;             // Unique email address
  role: enum;                // admin, manager, or therapist
  isActive: boolean;         // Account status
  firebaseUid: string;       // Firebase authentication ID
  phoneNumber?: string;      // Optional phone number
  profilePicture?: string;   // Optional profile picture URL
  lastLoginAt?: Date;        // Last login timestamp
  metadata?: object;         // Additional user metadata
  createdAt: Date;          // Auto-generated by Mongoose
  updatedAt: Date;          // Auto-generated by Mongoose
}
```

## Integration with Existing Routes

The AuthGuard has been updated to:
1. Verify Firebase tokens
2. Check if user exists in MongoDB (create if not)
3. Verify user is active
4. Check role-based permissions for protected routes
5. Allow managers/admins to access other users' resources

## Error Handling

- `401 Unauthorized`: Invalid or missing token, or inactive user
- `403 Forbidden`: Insufficient permissions for the requested operation
- `404 Not Found`: User not found
- `409 Conflict`: User already exists (for creation endpoints)
- `400 Bad Request`: Invalid data or business rule violation

## Best Practices

1. Always use Firebase Authentication for user registration
2. The MongoDB user record is automatically created on first login
3. Use the `/users/me` endpoint to get current user info
4. Managers should use the search and filter features to find users
5. Regular users can only update their own profile (limited fields)
6. Only managers/admins can change roles and activation status